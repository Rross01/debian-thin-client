# Структура проекта
```
.  
├── auto                        # Параметры команд lb config, build, clean
├── config
│   ├── hooks                   # Внешние скрипты, выполняемые в live, или в chroot
│   ├── includes.chroot         # Файлы, помещаемые в корень chroot
│   ├── includes.installer      # Файлы, помещаемые в корень live
│   ├── package-lists  
│   │   └── *.list.chroot       # Пакеты для установки в live
│   │   └── *.list.binary       # Пакеты для установки в chroot
├── Makefile    # Основная инструкция для автоматизации сборки
```


### auto/
* `auto/config` устанавливает базовые параметры для сборки, таких как архитектура, загрузчик, тип конечной файловой системы и т.д. Подробней в [`man lb config`](https://manpages.debian.org/bullseye/live-build/lb_config.1.en.html).
* `auto/clean` запускается автоматически (определено в Makefile) перед каждой сборкой. Очищает все временные файлы и кэши, которые могли остаться после предыдущей сборки. Подробней в [`man lb clean`](https://manpages.debian.org/bullseye/live-build/lb_clean.1.en.html).
* `auto/build` содержит параметры сборки. Подробнее в [`man lb build`](https://manpages.debian.org/bullseye/live-build/live-build.7.en.html).


### config/includes.chroot/

Структура этой папки будет помещена в корень chroot системы. Используется для размещения конфигурационных файлов, или временных файлов, необходимых на этапе сборки.


### config/package-lists/

* `*.chroot`: список пакетов, которые будут установлены в chroot
* `*.binary`: список дополнительных пакетов, которых будут добавлены в live систему по пути `pool/`. Скачанные пакеты будут использоваться как офлайн репозиторий во время установки. Не обязательно для корректной установки.


### config/packages.chroot/

`.deb` пакеты, помещённые в эту папку будут установленны в chroot (если папки нет, то достаточно просто создать её).
Замечание - пакеты, помещённые в эту папку, не будут получать обновления через apt в конечной системе.


### config/includes.installer/

`preseed.cfg` используется для задания параметров установки. Подробнее в [preseeding](https://wiki.debian.org/Preseed).


### config/hooks/

Скрипты, выполняемые на разных этапах сборки (`*.hook.chroot` внутри chroot, `.*chroot.binary` внутри live). Подробнее в `/usr/share/doc/live-build/examples/hooks/`.


# Инструкция по сборке

## Требования:
1. ОС Debian 11 "Bullseye".
2. Порядка 12 Гб свободного места, необходимого для сборки.
3. Включенная подсистема виртуализации в BIOS (для тестовых запусков итогового iso образа).
4. Установленный пакет `make`.
5. Включённые `contrib` и `non-free` репозитории.
```
deb http://deb.debian.org/debian/ bullseye main contrib non-free
deb-src http://deb.debian.org/debian/ bullseye main contrib non-free
deb http://security.debian.org/debian-security bullseye-security main contrib non-free
deb-src http://security.debian.org/debian-security bullseye-security main contrib non-free
deb http://deb.debian.org/debian/ bullseye-updates main contrib non-free
deb-src http://deb.debian.org/debian/ bullseye-updates main contrib non-fre
```


## Makefile

- **`make install_buildenv`** - устанавливает все необходимые зависимости для сборки образа и запуска вируальных машин через libvirt.
- **`make build`** - запускает очистку прошлой сборки (`lb clean --all`), задаёт параметры сборки (`lb config`), и выполняет сборку образа (`lb build`).
- **`make tests`** - копирует итоговый iso образ в директорию `/var/lib/libvirt/images/`, откуда поочерёдно создаёт виртуальную машину сначала в режиме BIOS (Legacy), после её закрытия создаёт другую виртуальную машину в режиме UEFI. Подробные параметры см. в `Makefile`.

## Автоматизированное тестирование iso образа
В `Makefile` описаны отдельные инструкции, запускающие чистую виртуальную машину с итогового iso образа.  

Консольная утилита `vish-install` при удачном запуске виртуальной машины будет пытаться запустить GUI приложение, предоставляющее доступ к виртуальному экрану машины. Для удобства, можно настроить проброс этого окна через SSH (X11 forwarding).  
Для этого достаточно в файле `/etc/ssh/sshd_config` сервера сборки прописать опцию `X11Forwarding yes`, и по SSH подключиться к серверу сборки через программу MobaXterm, которая уже имеет встроенный X11 сервер.


# Системные требования к тонкому клиенту
- **CPU:** Во время работы за VDI и трансляции видеопотока загрузка процессора Intel Celeron N3010 держалась в районе 60%. В теории возможно работа на ещё более слабых, или старых процессорах. Основное требование - поддержка 64-х битной архитектуры.
- **RAM:** 2 Гб
- **Дисковое пространсов:** порядка 5 Гб с учётом накапливаемых лог файлов.


# Установка
1. Через Rufus **в DD режиме** записать iso образ на флешку. Достаточно будет флешки объёмом 2 Гб. Подробности о отличие режимов записи ISO и DD по [ссылке](https://github.com/pbatard/rufus/issues/843).
2. Загружаемся с флешки.
3. Далее установочник сам подставит необходимые параметры установки, спросив лишь имя конечного тонкого клиента. В некоторых ситуациях установочник также может спросить, на какой диск установить систему.

# Установка в Legacy режиме
1. Предварительно на диске, куда будет установлена система, изменить таблицу разделов на MBR, т.к. при загрузке в Legacy режиме система не распозанет GPT разметку.
2. Запуститься с установочной флешки в Legacy режиме, **не UEFI**. В таком случае установщик сам распознает режим установки.


# Инструменты администрирования
1. VNC сервер, стартуемый как systemd юнит.
2. Cockpit. Представляет из себя Web интерфейс, через который доступна основная информация о аппаратной части устройстве, статусы сервисов, логи, терминал прямо в браузере и т.д. Авторизация происходит на основе локальных пользователей. Веб интерфейс доступен по 9090 порту устройства.
3. (в дальнейшем) Централизованное управление конфигурациями посредством Ansible или Puppet.